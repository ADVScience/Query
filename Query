# Поиск отклонения стоимости каждого товара от средней стоимость всех товаров
SELECT user_id, count(order_id) as orders_count, 
(
SELECT
round((count(order_id)::decimal/count(DISTINCT user_id)::decimal),2)
FROM user_actions
WHERE action = 'create_order'
) as orders_avg,
count(order_id) - (
SELECT
round((count(order_id)::decimal/count(DISTINCT user_id)::decimal),2)
FROM user_actions
WHERE action = 'create_order'
)
as orders_diff
FROM user_actions
WHERE action = 'create_order'
group by user_id
ORDER BY user_id
LIMIT 1000

# Поиск id заказов в которых содержится хотя бы один из пяти самых дорогих товаров
with 
top_prod as (SELECT product_id
FROM   products
ORDER BY price desc limit 5), 
unnest as (SELECT order_id,
product_ids,
unnest(product_ids) as product_id
FROM   orders)

SELECT DISTINCT order_id, product_ids
FROM unnest
WHERE product_id IN (SELECT * FROM top_prod)
ORDER BY order_id
